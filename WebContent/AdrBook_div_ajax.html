<!DOCTYPE html>
<html>

<head>

	<!--引入外部的js文件-->
    <!-- include BlockUI -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
	<script src="http://malsup.github.io/jquery.blockUI.js"></script>
	<!--引入內部的css文件-->
    <link rel="stylesheet" href="css/style.css" />
    <!--引入內部的js文件-->
    <script type="text/javascript" src="js/drag_drop.js" ></script>
    <script type="text/javascript" src="js/process.js" ></script>
    <script type="text/javascript" src="js/ajax_crud.js" ></script>
    <script type="text/javascript" src="js/attribute_setter.js" ></script>
    <script type="text/javascript" src="js/attribute_getter.js" ></script>



    <!-- 選擇所需圖示類型的載入 -->
    <!-- 這裡會載入 solid 和 regular 這兩類的圖示，最後要記得載入 fontawesome.js -->
    <script src="https://use.fontawesome.com/releases/v5.0.0/js/solid.js"></script>
    <script src="https://use.fontawesome.com/releases/v5.0.0/js/regular.js"></script>
    <script src="https://use.fontawesome.com/releases/v5.0.0/js/fontawesome.js"></script>
</head>

<body>
    <div>
        <h2 style="text-align:center"> AddressBook_lab</h2>
    </div>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.css"></script>
        <button id="add-btn" class="addressbook-table-btn"><i class="fas fa-plus-square"></i></button>
        <button id="del-check-btn" class="addressbook-table-btn"><i class="fas fa-user-times"></i></button>
        <BR>
        <div class="addressbook-table">
            <div class="thead">
                <div class="tr">
                    <div  class="th"><input type="checkbox" class="checkbox_all" /><br><span>select all</span></div>
                    <div  class="th">No(編號)</div>
                    <div  class="th">Name(姓名)</div>
                    <div  class="th">tel(電話)</div>
                    <div  class="th">gender(性別)</div>
                    <div  class="th">type(類型)</div>
                    <div  class="th">notes(備註)</div>
                    <div  class="th">function(功能)</div>
                    <div  class="th">Update Date(更新時間)</div>
                </div>
            </div>
            <div class="tbody">
            </div>
        </div>
<!--樣板-->
<span id="temp" style="display: none">
<div id="div-tr-temp" class="tr"  >

        <div id="checkbox" class="td">
            <div class="checkbox">
                <div id="_id" ><div class="text"></div></div>
                <input type="checkbox"/>
            </div>
        </div>
        <div id="no" class="td"><div class="text" style="display: none;"></div><input type="text"></div>
        <div id="name" class="td"><div class="text"></div><input type="text"></div>
        <div id="tel" class="td"><div class="text"></div><input type="text"></div>
        <div id="gender" class="td"><div class="text"></div>
            <input type="radio" name="gender" value="male" checked="checked"><div class="inner_text">男性</div>
            <input type="radio" name="gender" value="female"><div class="inner_text">女性</div>
        </div>
        <div id="type" class="td"><div class="text"></div>
            <div class="selectIndex" style="display: none;"></div>
            <select>
                <option>同學</option>
                <option>家庭</option>
                <option>工作夥伴</option>
            </select>
        </div>
        <div id="notes" class="td"><div class="text"></div><textarea></textarea></div>
        <div id="function" class="td">
            <button id="save-btn" class="save-btn"><i class="fas fa-save"></i></button>
            <button id="cancel-btn" class="cancel-btn"><i class="fas fa-window-close"></i></button>
            <button id="edit-btn" class="edit-btn" style="display: none;"><i class="fas fa-pen-square"></i></button>
            <button id="del-btn" class="del-btn" style="display: none;"><i class="far fa-trash-alt"></i></button>
        </div>
        <div id="timestamp" class="td"><div class="text" style="display: none;"></div></div>
</div>
</span>
<!--  <button id="test" class="test"><i class="far fa-trash-alt"></i></button> -->
</body>
<script>
//String.prototype.replaceAll = function(s1,s2){
//    return this.replace(new RegExp(s1,"gm"), s2);
//}

    var map_multi_data={};
    var loc_ser_number = 0;// store gender 's radio name serial_number
    var object_show_hide_key =
     {
      "1":["input:not(:checkbox)",".inner_text","select","textarea",".save-btn",".cancel-btn",".checkbox > #_id"]
     ,"2":[".edit-btn",".del-btn",".text","input[type=checkbox]"]
     };

    $(document).ready(function(){
    	map_multi_data = ajax_get();
        loc_ser_number = localStorage.getItem("loc_ser_number");
        if(map_multi_data==null)map_multi_data={};// if loc_map is null , then give a  new {}
        let size_map_multi_data = Object.keys(map_multi_data).length;
        console.log("init:"+loc_ser_number);
        console.log(map_multi_data);
        if(!size_map_multi_data==0){
            load_data_from_loc_storage(map_multi_data,size_map_multi_data);
        }
        mode_change_event($(".tbody"),"read");
        select_all_tr_add_draggble_evnetlistener();
    });
    function isNull(str){
        if(str !== null || str !== undefined || str !== "") return false;
    }
     //$("#test").click(function () {
     //    alert(ajax_get());
     //});
    function mode_change_event(obj,mode){
        $.each(object_show_hide_key,function(key,object){
            $.each(object,function(index,value){
                if((mode=="read" &&key=="1")||(mode=="edit" &&key=="2")){// "1": element like input , select, textarea, save-btn,cancel-btn
                    console.log("key: " +key);
                    obj.find(value).hide();
                }else{// "2": element like .text , del-btn,edit-btn
                    obj.find(value).show();
                }
            });
        });
    }
    function block_ui(){
    	$.blockUI(
    	    	{ css:
    	    		{
    	    	        border: 'none',
    		            padding: '15px',
    		            backgroundColor: '#000',
    		            '-webkit-border-radius': '10px',
    		            '-moz-border-radius': '10px',
    		            opacity: .5,
    		            color: '#fff'
    	        	}
    	    	}
    	);
    	setTimeout($.unblockUI, 1000);
    }
    /*新增動作
    1.新增一個樣板
    2.將新增按鈕隱藏
    */
    $("#add-btn").click(function () {
        add_process();
    });
    /*
    0.儲存動作
    1.將樣板內容input 存起來
    2.將input的元素隱藏，將填入的值放入.text 的元素
    3.將填入的值 經由 集合{鍵值組}儲存
    */
    $(".tbody").on("click",".save-btn",function () {
    	block_ui();
        let obj_div_tr = getTrObjFromBtn($(this));//取得按鈕上的tr
        let add_flag = false;
        if (obj_div_tr.find("#timestamp > .text").text().length==0)add_flag=true;
        let map_sing_data = save_process(obj_div_tr);
        // var no = obj_div_tr.find($("#no > input")).val();//取得no 內的值
        // map_multi_data[no.toString()] = map_sing_data;//儲存資料
        console.log("add_flag :"+add_flag);
        if(add_flag){
            ajax_post(map_sing_data);
        }
        else{
            ajax_put(map_sing_data);//應該改用put
        }
        load_data(ajax_get());
        // 將編輯格式隱藏
        mode_change_event(obj_div_tr,"read");
    });

    /*
    0.點選pencil進入編輯模式
    1.將樣板內容 隱藏，將input 顯示
    */
    $(".tbody").on("click",".edit-btn",function () {
    	block_ui();
        let obj_div_tr = getTrObjFromBtn($(this));//取得按鈕上的tr
        //將.text 資料塞入 input
        edit_process(obj_div_tr);
        //將閱讀格式隱藏，將原text欄位隱藏
        mode_change_event(obj_div_tr,"edit");
    });
    /*
    0.點選x-btn 將編輯模式取消，回到顯示模式
    1.將樣板內容 顯示，將input 隱藏
    2.將.text 資料塞回 input,textarea,select
    */
    $(".tbody").on("click",".cancel-btn",function () {
    	block_ui();
    	let obj_div_tr = getTrObjFromBtn($(this));//取得按鈕上的tr
    	let timestamp = obj_div_tr.find($("#timestamp > .text")).text();//取得name 內的值
        if((timestamp!=null && timestamp!="")){//判斷已經儲存過
	        //將閱讀格式隱藏，將原text欄位隱藏
	        mode_change_event(obj_div_tr,"read");
        }else{//第一次產生的DOM
        	console.log("第一次產生被取消");
            del_process(obj_div_tr);
        }
    });
    /*
    0.點選garbage-btn 將編輯模式取消，回到顯示模式
    1.將tr元素移除、清空
    */
    $(".tbody").on("click",".del-btn",function () {
    	block_ui();
    	let obj_div_tr = getTrObjFromBtn($(this));//取得按鈕上的tr
    	let name = obj_div_tr.find("#name .text").text();
    	let check = confirm("Are you sure you want to delete "+name+"from AddressBook?");
        if(check){
            map_multi_data = {};//將資料刷新重新存
            del_process(obj_div_tr);
        }
    });
    /*
    0.點選check(select all) selector : checkbox
    */
    $(".checkbox_all").click(function(){
    	let obj_checkbox_all = $(this);
    	let check_flag = obj_checkbox_all.prop("checked");
    	let obj_input_checkbox = $(".tbody  input[type=checkbox]");
        obj_input_checkbox.each(function(idx,val){
        	let obj = $(this);//get each item
            if(check_flag){
                obj.prop("checked",true);
            }else{
                obj.prop("checked",false);
            }
        });
    });
    /*
    0.點選check(single checkbox) selector : checkbox
    */
    $("#del-check-btn").click(function(){
    	block_ui();
    	let obj_input_checkbox = $(".tbody input[type=checkbox]");
        obj_input_checkbox.each(function(idx,val){
        	let obj = $(this);//get each item
        	let obj_div_tr = getTrObjFromBtn(obj).parent();
        	let check_flag = obj.prop("checked");
            if(check_flag){
            	let objID=$(obj_div_tr).find("#_id").text();
                ajax_delete(objID);
                obj_div_tr.remove();
            }
        });
        map_multi_data = {};//將資料刷新重新存
        reload_del_process();
    });

</script>

</html>